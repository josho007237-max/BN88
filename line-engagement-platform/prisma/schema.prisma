generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Audience {
  id          String  @id @default(cuid())
  lineUserId  String  @unique
  displayName String?
  locale      String?

  // เก็บเป็น JSON string แทน String[]
  // ตอนใช้จริงให้ JSON.parse / JSON.stringify ใน TypeScript
  tags String? @default("[]")

  lastActiveAt DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  events     Event[]
  deliveries CampaignDelivery[]
}

model Event {
  id   String @id @default(cuid())
  type String

  // เก็บ payload เป็น JSON string
  payload    String?  @default("{}")
  occurredAt DateTime @default(now())

  audienceId String?
  audience   Audience? @relation(fields: [audienceId], references: [id], onDelete: SetNull)
}

model Campaign {
  id          String  @id @default(cuid())
  name        String
  description String?

  // ถ้ามีฟิลด์อื่นของ Campaign (เช่น type, status ฯลฯ)
  // สามารถเพิ่มต่อจากนี้ได้ เช่น:
  // type      String?
  // status    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deliveries CampaignDelivery[]
  schedules  CampaignSchedule[]
}

model CampaignSchedule {
  id         String   @id @default(cuid())
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  campaignId String

  // cron expression เช่น "0 9 * * *"
  cronExpression String

  // timezone เช่น "Asia/Bangkok"
  timezone String

  isActive  Boolean   @default(true)
  lastRunAt DateTime?
  nextRunAt DateTime?

  // ใช้กันซ้ำเวลา add job (ผูกกับ jobId ของ queue)
  idempotencyKey String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CampaignDelivery {
  id         String    @id @default(cuid())
  campaignId String
  audienceId String
  status     String
  sentAt     DateTime?
  error      String?

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  audience Audience @relation(fields: [audienceId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([audienceId])
}
