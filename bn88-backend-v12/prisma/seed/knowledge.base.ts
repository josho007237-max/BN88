// prisma/seed/knowledge.base.ts
import type { PrismaClient } from "@prisma/client";

type SeedChunk = {
  orderIndex: number;
  heading: string;
  content: string;
};

type SeedDoc = {
  title: string;
  tags?: string;
  body?: string;
  status?: "active" | "draft" | "archived";
  chunks: SeedChunk[];
};

const DEFAULT_TENANT = "bn9";

const SEED_DOCS: SeedDoc[] = [
  {
    title: "à¸ªà¸¡à¸±à¸„à¸£à¸ªà¸¡à¸²à¸Šà¸´à¸",
    tags: "faq,register,à¸ªà¸¡à¸±à¸„à¸£",
    body:
      "à¸„à¸¹à¹ˆà¸¡à¸·à¸­à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸ªà¸¡à¸±à¸„à¸£à¸ªà¸¡à¸²à¸Šà¸´à¸à¹€à¸šà¸·à¹‰à¸­à¸‡à¸•à¹‰à¸™ à¸§à¸´à¸˜à¸µà¸‚à¸­ USER, à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸à¸²à¸£à¸ªà¸¡à¸±à¸„à¸£ à¹à¸¥à¸°à¸‚à¹‰à¸­à¸„à¸§à¸£à¸£à¸°à¸§à¸±à¸‡à¸•à¹ˆà¸²à¸‡ à¹†",
    status: "active",
    chunks: [
      {
        orderIndex: 1,
        heading: "à¸§à¸´à¸˜à¸µà¸ªà¸¡à¸±à¸„à¸£à¸ªà¸¡à¸²à¸Šà¸´à¸à¸œà¹ˆà¸²à¸™ LINE",
        content:
          "à¸¥à¸¹à¸à¸„à¹‰à¸²à¸ªà¸²à¸¡à¸²à¸£à¸–à¸ªà¸¡à¸±à¸„à¸£à¸ªà¸¡à¸²à¸Šà¸´à¸à¹„à¸”à¹‰à¹‚à¸”à¸¢à¸à¸²à¸£à¸à¸”à¸—à¸µà¹ˆà¹€à¸¡à¸™à¸¹à¸ªà¸¡à¸±à¸„à¸£à¸ªà¸¡à¸²à¸Šà¸´à¸à¹ƒà¸™à¸«à¸™à¹‰à¸²à¹à¸Šà¸— LINE à¸ˆà¸²à¸à¸™à¸±à¹‰à¸™à¸à¸£à¸­à¸à¸Šà¸·à¹ˆà¸­â€“à¸™à¸²à¸¡à¸ªà¸à¸¸à¸¥ à¹à¸¥à¸°à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£à¹ƒà¸«à¹‰à¸„à¸£à¸š à¸£à¸­à¸£à¸°à¸šà¸šà¸ªà¹ˆà¸‡ USER à¹à¸¥à¸°à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¸à¸¥à¸±à¸šà¹ƒà¸«à¹‰à¹ƒà¸™à¹à¸Šà¸—à¸ à¸²à¸¢à¹ƒà¸™à¹„à¸¡à¹ˆà¸à¸µà¹ˆà¸™à¸²à¸—à¸µ",
      },
      {
        orderIndex: 2,
        heading: "à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸à¸²à¸£à¸ªà¸¡à¸±à¸„à¸£",
        content:
          "1) à¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£à¸—à¸µà¹ˆà¸•à¸´à¸”à¸•à¹ˆà¸­à¹„à¸”à¹‰à¸ˆà¸£à¸´à¸‡\n2) 1 à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£ / 1 à¸šà¸±à¸à¸Šà¸µà¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ à¸«à¹‰à¸²à¸¡à¸ªà¸¡à¸±à¸„à¸£à¸‹à¹‰à¸³\n3) à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¸ªà¸¡à¸±à¸„à¸£à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸£à¸´à¸‡ à¹€à¸žà¸·à¹ˆà¸­à¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¸›à¸±à¸à¸«à¸²à¸à¸²à¸â€“à¸–à¸­à¸™à¹ƒà¸™à¸­à¸™à¸²à¸„à¸•",
      },
    ],
  },
  {
    title: "à¸à¸²à¸£à¸à¸²à¸â€“à¸–à¸­à¸™à¹€à¸‡à¸´à¸™",
    tags: "faq,deposit,withdraw,à¸à¸²à¸,à¸–à¸­à¸™",
    body:
      "à¸­à¸˜à¸´à¸šà¸²à¸¢à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸à¸²à¸£à¸à¸²à¸â€“à¸–à¸­à¸™ à¸§à¸´à¸˜à¸µà¹à¸™à¸šà¸ªà¸¥à¸´à¸› à¹à¸ˆà¹‰à¸‡à¸›à¸±à¸à¸«à¸²à¸à¸²à¸à¹„à¸¡à¹ˆà¹€à¸‚à¹‰à¸² à¹à¸¥à¸°à¸£à¸°à¸¢à¸°à¹€à¸§à¸¥à¸²à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹‚à¸”à¸¢à¸—à¸µà¸¡à¸‡à¸²à¸™",
    status: "active",
    chunks: [
      {
        orderIndex: 1,
        heading: "à¸§à¸´à¸˜à¸µà¸à¸²à¸à¹€à¸‡à¸´à¸™à¹à¸šà¸šà¸›à¸à¸•à¸´",
        content:
          "à¹ƒà¸«à¹‰à¸¥à¸¹à¸à¸„à¹‰à¸²à¹€à¸‚à¹‰à¸²à¹€à¸¡à¸™à¸¹à¸à¸²à¸à¹€à¸‡à¸´à¸™ à¹€à¸¥à¸·à¸­à¸à¸˜à¸™à¸²à¸„à¸²à¸£à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£ à¹à¸¥à¹‰à¸§à¹‚à¸­à¸™à¸•à¸²à¸¡à¸ˆà¸³à¸™à¸§à¸™à¸—à¸µà¹ˆà¸£à¸°à¸šà¸šà¹à¸ªà¸”à¸‡ à¸ˆà¸²à¸à¸™à¸±à¹‰à¸™à¹à¸™à¸šà¸ªà¸¥à¸´à¸›à¹ƒà¸™à¹à¸Šà¸— à¸«à¸£à¸·à¸­à¸à¸”à¸›à¸¸à¹ˆà¸¡à¹à¸ˆà¹‰à¸‡à¸à¸²à¸ à¸£à¸°à¸šà¸šà¸ˆà¸°à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸¢à¸­à¸”à¹à¸¥à¸°à¹€à¸•à¸´à¸¡à¹€à¸„à¸£à¸”à¸´à¸•à¹ƒà¸«à¹‰à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¸ à¸²à¸¢à¹ƒà¸™ 1â€“5 à¸™à¸²à¸—à¸µ",
      },
      {
        orderIndex: 2,
        heading: "à¸«à¸²à¸à¸à¸²à¸à¹à¸¥à¹‰à¸§à¹€à¸‡à¸´à¸™à¹„à¸¡à¹ˆà¹€à¸‚à¹‰à¸²",
        content:
          "à¸«à¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¸à¸²à¸à¹€à¸‡à¸´à¸™à¹„à¸›à¹à¸¥à¹‰à¸§à¹€à¸à¸´à¸™ 10 à¸™à¸²à¸—à¸µà¹à¸¥à¹‰à¸§à¸¢à¸­à¸”à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹€à¸‚à¹‰à¸² à¹ƒà¸«à¹‰à¹à¸ˆà¹‰à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸”à¸±à¸‡à¸™à¸µà¹‰: USER, à¸Šà¸·à¹ˆà¸­à¸ˆà¸£à¸´à¸‡, à¸˜à¸™à¸²à¸„à¸²à¸£à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¹‚à¸­à¸™, à¹€à¸¥à¸‚à¸šà¸±à¸à¸Šà¸µ, à¸¢à¸­à¸”à¸—à¸µà¹ˆà¹‚à¸­à¸™, à¹€à¸§à¸¥à¸²à¹‚à¸­à¸™à¹‚à¸”à¸¢à¸›à¸£à¸°à¸¡à¸²à¸“ à¹à¸¥à¸°à¹à¸™à¸šà¸ªà¸¥à¸´à¸› à¸£à¸°à¸šà¸šà¸ˆà¸°à¸ªà¹ˆà¸‡à¹€à¸£à¸·à¹ˆà¸­à¸‡à¹ƒà¸«à¹‰à¸—à¸µà¸¡à¸‡à¸²à¸™à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ à¸²à¸¢à¹ƒà¸™ 5â€“15 à¸™à¸²à¸—à¸µ",
      },
      {
        orderIndex: 3,
        heading: "à¸à¸²à¸£à¸–à¸­à¸™à¹€à¸‡à¸´à¸™",
        content:
          "à¸à¸²à¸£à¸–à¸­à¸™à¹€à¸‡à¸´à¸™à¹ƒà¸«à¹‰à¸¥à¸¹à¸à¸„à¹‰à¸²à¹€à¸‚à¹‰à¸²à¹€à¸¡à¸™à¸¹à¸–à¸­à¸™ à¸à¸£à¸­à¸à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸–à¸­à¸™ à¸£à¸°à¸šà¸šà¸ˆà¸°à¹‚à¸­à¸™à¸à¸¥à¸±à¸šà¹„à¸›à¸¢à¸±à¸‡à¸šà¸±à¸à¸Šà¸µà¸—à¸µà¹ˆà¸œà¸¹à¸à¹„à¸§à¹‰à¸›à¸à¸•à¸´à¹ƒà¸Šà¹‰à¹€à¸§à¸¥à¸²à¸—à¸³à¸£à¸²à¸¢à¸à¸²à¸£à¸›à¸£à¸°à¸¡à¸²à¸“ 5â€“15 à¸™à¸²à¸—à¸µ à¸—à¸±à¹‰à¸‡à¸™à¸µà¹‰à¸‚à¸¶à¹‰à¸™à¸­à¸¢à¸¹à¹ˆà¸à¸±à¸šà¸˜à¸™à¸²à¸„à¸²à¸£à¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡à¸”à¹‰à¸§à¸¢",
      },
    ],
  },
];

async function upsertKnowledgeDoc(
  prisma: PrismaClient,
  tenant: string,
  doc: SeedDoc
) {
  const existing = await prisma.knowledgeDoc.findFirst({
    where: {
      tenant,
      title: doc.title,
    },
  });

  if (existing) {
    return existing;
  }

  // ðŸ”´ à¸ˆà¸¸à¸”à¸ªà¸³à¸„à¸±à¸: model KnowledgeDoc à¹„à¸¡à¹ˆà¸¡à¸µ field body / tags
  // à¹ƒà¸Šà¹‰ description à¹à¸—à¸™ à¹‚à¸”à¸¢à¹€à¸­à¸² body + tags à¸¡à¸²à¸£à¸§à¸¡à¸à¸±à¸™à¹€à¸›à¹‡à¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹€à¸”à¸µà¸¢à¸§
  const descriptionParts: string[] = [];
  if (doc.body && doc.body.trim()) descriptionParts.push(doc.body.trim());
  if (doc.tags && doc.tags.trim())
    descriptionParts.push(`à¹à¸—à¹‡à¸: ${doc.tags.trim()}`);

  const description =
    descriptionParts.length > 0 ? descriptionParts.join("\n\n") : null;

  return prisma.knowledgeDoc.create({
    data: {
      tenant,
      title: doc.title,
      status: doc.status ?? "active",
      description,
    },
  });
}

export async function seedKnowledgeBase(
  prisma: PrismaClient,
  tenant: string = DEFAULT_TENANT
) {
  console.log(`[seedKnowledgeBase] seeding knowledge for tenant="${tenant}"`);

  for (const doc of SEED_DOCS) {
    const kd = await upsertKnowledgeDoc(prisma, tenant, doc);

    await prisma.knowledgeChunk.deleteMany({
      where: { tenant, docId: kd.id },
    });

    if (doc.chunks.length === 0) continue;

    await prisma.knowledgeChunk.createMany({
      data: doc.chunks.map((c) => ({
        tenant,
        docId: kd.id,
        orderIndex: c.orderIndex,
        heading: c.heading,
        content: c.content,
        embedding: [],
        tokens: 0,
      })),
    });

    console.log(
      `[seedKnowledgeBase] doc "${doc.title}" seeded with ${doc.chunks.length} chunks`
    );
  }

  console.log("[seedKnowledgeBase] done");
}
